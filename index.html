<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Meine Lieblingsrezepte ‚Äì Cover & Inhaltsverzeichnis</title>

  <style>
    /* ========== Design-Variablen (Pastell) ========== */
    :root{
      --beige:#F6F1E7;
      --text:#2b2b2b;
      --muted:#7b7b7b;
      --border:#e4dccb;

      --gelb:#FFF6BF;        /* Fr√ºhst√ºck */
      --mint:#CFF5E7;        /* Hauptspeisen */
      --rosa:#FFD3E2;        /* Bakery */
      --orange:#FFD8B1;      /* Snacks & Desserts */
      --blau:#CFE9FF;        /* Drinks */

      --link:#3a6ea5;
      --link-hover:#214e7c;

      --shadow: 0 6px 18px rgba(0,0,0,.06);
      --radius: 18px;
      --radius-sm: 12px;
      --maxw: 700px;
      --iphone-w: 430px;
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      color:var(--text);
      background:#ffffff;
      line-height:1.55;
    }
    .page{ margin:0 auto; width:100%; max-width:var(--iphone-w); }
  </style>
</head>
<body>

<!-- =========================
     ‚ûï Rezept hinzuf√ºgen (Modal)
========================== -->
<style>
  .add-btn {
    position: fixed; top: 14px; left: 14px; z-index: 1000;
    display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 12px; border-radius: 12px;
    background:#fff; border:1px solid #ddd; box-shadow: 0 6px 16px rgba(0,0,0,.08);
    color:#222; text-decoration: none; font-size: 14px;
  }
  .modal-backdrop{ position: fixed; inset:0; background: rgba(0,0,0,.25);
    display:none; align-items:center; justify-content:center; z-index: 1001; }
  .modal { width: min(720px, 92vw); background:#fff; border:1.5px solid #eee;
    border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.12); padding: 16px 16px 4px; }
  .modal h3{ margin: 2px 0 10px; }
  .modal .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .modal label{ font-size: 12px; color: #666; display:block; margin-bottom:4px; }
  .modal input, .modal select, .modal textarea{
    width:100%; padding:10px 12px; border:1.5px solid #e5e5e5; border-radius:12px; font-size:14px;
    outline:none; background:#fff;
  }
  .modal textarea{ min-height:120px; resize: vertical; }
  .modal .actions{ display:flex; gap:10px; justify-content:flex-end; padding: 10px 0 6px; }
  .btn{ padding:10px 12px; border-radius:10px; border:1px solid #ddd; background:#f8f8f8; cursor:pointer; }
  .btn.primary{ background:#2f6fed; border-color:#2a61d0; color:#fff; }
</style>

<a class="add-btn" href="#" id="openAddRecipe">‚ûï Rezept</a>

<div class="modal-backdrop" id="addRecipeModal">
  <form class="modal" id="recipeForm">
    <h3>Neues Rezept hinzuf√ºgen</h3>

    <div class="grid">
      <div>
        <label for="title">Name des Rezepts</label>
        <input id="title" type="text" required>
      </div>
      <div>
        <label for="servings">Portionen</label>
        <input id="servings" type="number" min="1" value="4" required>
      </div>
      <div>
        <label for="prep">Zubereitungszeit</label>
        <input id="prep" type="text" required>
      </div>
      <div>
        <label for="total">Gesamtzeit</label>
        <input id="total" type="text" required>
      </div>
      <div>
        <label for="category">Hauptkategorie</label>
        <select id="category" required></select>
      </div>
      <div>
        <label for="subcategory">Unterkategorie</label>
        <select id="subcategory" disabled></select>
      </div>
    </div>

    <div style="margin-top:12px">
      <label for="ingredients">Zutaten (eine pro Zeile)</label>
      <textarea id="ingredients"></textarea>
    </div>
    <div style="margin-top:12px">
      <label for="steps">Zubereitung (Schritte; eine pro Zeile)</label>
      <textarea id="steps"></textarea>
    </div>

    <div class="actions">
      <button type="button" class="btn" id="cancelAdd">Abbrechen</button>
      <button type="submit" class="btn primary">Speichern</button>
    </div>
  </form>
</div>


  <script>
/* =======================
   Kategorien + Unterkategorien
   ======================= */
window.CATS = {
  "Fr√ºhst√ºck": {
    color: "var(--gelb)",
    subs: {
      "Brot & Aufstriche": {},
      "Sonstiges": {}
    }
  },
  "Hauptspeisen": {
    color: "var(--mint)",
    subs: {
      "Suppen & Eint√∂pfe": {},
      "Pasta & Nudeln": {},
      "Pizza": {},
      "Reis & Getreidegerichte": {},
      "Internationale K√ºche & Currys": {}
    }
  },
  "Bakery": {
    color: "var(--rosa)",
    subs: {}
  },
  "Snacks & Desserts": {
    color: "var(--orange)",
    subs: {}
  },
  "Drinks": {
    color: "var(--blau)",
    subs: {
      "Alkoholische Getr√§nke": {},
      "Nicht-alkoholische Getr√§nke": {}
    }
  }
};

/* ===== Dropdowns im Modal mit den Kategorien f√ºllen ===== */
(function(){
  const catSel = document.getElementById('category');
  const subSel = document.getElementById('subcategory');

  function rebuildSubcats(){
    subSel.innerHTML = '';
    const cat = catSel.value;
    const subs = (window.CATS[cat]?.subs) || {};
    if(Object.keys(subs).length===0){
      subSel.disabled = true;
      return;
    }
    subSel.disabled = false;
    for(const s of Object.keys(subs)){
      const o = document.createElement('option');
      o.value = s; o.textContent = s;
      subSel.appendChild(o);
    }
  }

  for(const c of Object.keys(window.CATS)){
    const o = document.createElement('option');
    o.value = c; o.textContent = c;
    catSel.appendChild(o);
  }
  catSel.addEventListener('change', rebuildSubcats);
})();
</script>

<!-- ====================== INHALTSVERZEICHNIS + QUICKJUMP ====================== -->
<nav id="toc">
  <h2>üìñ Inhaltsverzeichnis</h2>

  <!-- Quickjump -->
  <div id="quickjump">
    <a href="#fruehstueck">üç≥ Fr√ºhst√ºck</a> |
    <a href="#hauptspeisen">üç≤ Hauptspeisen</a> |
    <a href="#bakery">üç∞ Bakery</a> |
    <a href="#snacks">üçä Snacks & Desserts</a> |
    <a href="#drinks">üçπ Drinks</a>
  </div>

  <!-- Fr√ºhst√ºck -->
  <div id="fruehstueck" class="cat">
    <h2>üç≥ Fr√ºhst√ºck</h2>
    <ul></ul>
    <h4>Brot</h4>
    <ul></ul>
    <h4>Aufstriche</h4>
    <ul></ul>
    <h4>Sonstiges</h4>
    <ul></ul>
  </div>

  <!-- Hauptspeisen -->
  <div id="hauptspeisen" class="cat">
    <h2>üç≤ Hauptspeisen</h2>
    <ul></ul>
    <h4>Suppen & Eint√∂pfe</h4>
    <ul></ul>
    <h4>Pasta & Nudeln</h4>
    <ul></ul>
    <h4>Pizza</h4>
    <ul></ul>
    <h4>Reis & Getreidegerichte</h4>
    <ul></ul>
    <h4>Internationale K√ºche & Currys</h4>
    <ul></ul>
    <h4>Snacks, Beilage & Fingerfood</h4>
    <ul></ul>
    <h4>Basics & Saucen</h4>
    <ul></ul>
    <h4>Curry-Paste</h4>
    <ul></ul>
  </div>

  <!-- Bakery -->
  <div id="bakery" class="cat">
    <h2>üç∞ Bakery</h2>
    <ul></ul>
    <h4>Kuchen & Torten</h4>
    <ul></ul>
    <h4>Pl√§tzchen & Kleingeb√§ck</h4>
    <ul></ul>
    <h4>Sonstiges Geb√§ck</h4>
    <ul></ul>
  </div>

  <!-- Snacks & Desserts -->
  <div id="snacks" class="cat">
    <h2>üçä Snacks & Desserts</h2>
    <ul></ul>
  </div>

  <!-- Drinks -->
  <div id="drinks" class="cat">
    <h2>üçπ Drinks</h2>
    <ul></ul>
    <h4>Alkoholische Getr√§nke</h4>
    <ul></ul>
    <h4>Nicht-alkoholische Getr√§nke</h4>
    <ul></ul>
  </div>
</nav>


<!-- ====================== COVER SEKTIONEN ====================== -->

<!-- Fr√ºhst√ºck-Cover -->
<section id="fruehstueck-cover" class="cover fruehstueck" 
         style="background:var(--gelb); min-height:70vh; display:flex; align-items:center; justify-content:center; text-align:center; padding:30px;">
  <div style="background:#fff; border:3px dashed #ffe680; border-radius:16px; padding:30px; max-width:92%; box-shadow:var(--shadow);">
    <h1 style="font-size:2em; margin:0;">ü•ê Fr√ºhst√ºck</h1>
    <p style="margin-top:10px; font-size:1em; color:var(--muted);">Guten Start in den Tag!</p>
  </div>
</section>

<!-- Unterkategorie Brot & Aufstriche -->
<section id="brot-und-aufstriche-cover" class="cover fruehstueck" 
         style="background-color:#FFF2CC; padding:60px 20px; text-align:center; border-radius:18px; margin:20px 0;">
  <h1 style="font-size:2em; margin:0;">Brot & Aufstriche</h1>
</section>

<!-- Unterkategorie Sonstiges -->
<section id="fruehstueck-sonstiges-cover" class="cover fruehstueck" 
         style="background-color:#FFF2CC; padding:60px 20px; text-align:center; border-radius:18px; margin:20px 0;">
  <h1 style="font-size:2em; margin:0;">Sonstiges</h1>
</section>


<!-- Hauptspeisen-Cover -->
<section id="hauptspeisen-cover" class="cover hauptspeisen" 
         style="background:var(--mint); min-height:70vh; display:flex; align-items:center; justify-content:center; text-align:center; padding:30px;">
  <div style="background:#fff; border:3px dashed #99e6b3; border-radius:16px; padding:30px; max-width:92%; box-shadow:var(--shadow);">
    <h1 style="font-size:2em; margin:0;">üç≤ Hauptspeisen</h1>
    <p style="margin-top:10px; font-size:1em; color:var(--muted);">Alles f√ºr mittags und abends.</p>
  </div>
</section>

<!-- Unterkategorie Suppen & Eint√∂pfe -->
<section id="suppen-und-eint√∂pfe-cover" class="cover hauptspeisen" 
         style="background-color:#E5FFF2; padding:60px 20px; text-align:center; border-radius:18px; margin:20px 0;">
  <h1 style="font-size:2em; margin:0;">Suppen & Eint√∂pfe</h1>
</section>

<!-- Unterkategorie Pasta & Nudeln -->
<section id="pasta-und-nudeln-cover" class="cover hauptspeisen" 
         style="background-color:#E5FFF2; padding:60px 20px; text-align:center; border-radius:18px; margin:20px 0;">
  <h1 style="font-size:2em; margin:0;">Pasta & Nudeln</h1>
</section>

<!-- Unterkategorie Pizza -->
<section id="pizza-cover" class="cover hauptspeisen" 
         style="background-color:#E5FFF2; padding:60px 20px; text-align:center; border-radius:18px; margin:20px 0;">
  <h1 style="font-size:2em; margin:0;">Pizza</h1>
</section>

<!-- Unterkategorie Reis & Getreidegerichte -->
<section id="reis-und-getreidegerichte-cover" class="cover hauptspeisen" 
         style="background-color:#E5FFF2; padding:60px 20px; text-align:center; border-radius:18px; margin:20px 0;">
  <h1 style="font-size:2em; margin:0;">Reis & Getreidegerichte</h1>
</section>

<!-- Unterkategorie Internationale K√ºche & Currys -->
<section id="internationale-k√ºche-und-currys-cover" class="cover hauptspeisen" 
         style="background-color:#E5FFF2; padding:60px 20px; text-align:center; border-radius:18px; margin:20px 0;">
  <h1 style="font-size:2em; margin:0;">Internationale K√ºche & Currys</h1>
</section>


<!-- Bakery-Cover -->
<section id="bakery-cover" class="cover bakery" 
         style="background:var(--rosa); min-height:70vh; display:flex; align-items:center; justify-content:center; text-align:center; padding:30px;">
  <div style="background:#fff; border:3px dashed #ff99bb; border-radius:16px; padding:30px; max-width:92%; box-shadow:var(--shadow);">
    <h1 style="font-size:2em; margin:0;">üç∞ Bakery</h1>
    <p style="margin-top:10px; font-size:1em; color:var(--muted);">Kuchen, Geb√§ck und mehr.</p>
  </div>
</section>


<!-- Snacks & Desserts-Cover -->
<section id="snacks-cover" class="cover snacks" 
         style="background:var(--orange); min-height:70vh; display:flex; align-items:center; justify-content:center; text-align:center; padding:30px;">
  <div style="background:#fff; border:3px dashed #ffb266; border-radius:16px; padding:30px; max-width:92%; box-shadow:var(--shadow);">
    <h1 style="font-size:2em; margin:0;">üçä Snacks & Desserts</h1>
    <p style="margin-top:10px; font-size:1em; color:var(--muted);">Kleine S√ºnden f√ºr zwischendurch.</p>
  </div>
</section>


<!-- Drinks-Cover -->
<section id="drinks-cover" class="cover drinks" 
         style="background:var(--blau); min-height:70vh; display:flex; align-items:center; justify-content:center; text-align:center; padding:30px;">
  <div style="background:#fff; border:3px dashed #99cfff; border-radius:16px; padding:30px; max-width:92%; box-shadow:var(--shadow);">
    <h1 style="font-size:2em; margin:0;">üçπ Drinks</h1>
    <p style="margin-top:10px; font-size:1em; color:var(--muted);">Erfrischend, bunt & manchmal frech.</p>
  </div>
</section>

<!-- Unterkategorie Alkoholische Getr√§nke -->
<section id="alkoholische-getr√§nke-cover" class="cover drinks" 
         style="background-color:#E6F0FF; padding:60px 20px; text-align:center; border-radius:18px; margin:20px 0;">
  <h1 style="font-size:2em; margin:0;">Alkoholische Getr√§nke</h1>
</section>

<!-- Unterkategorie Nicht-alkoholische Getr√§nke -->
<section id="nicht-alkoholische-getr√§nke-cover" class="cover drinks" 
         style="background-color:#E6F0FF; padding:60px 20px; text-align:center; border-radius:18px; margin:20px 0;">
  <h1 style="font-size:2em; margin:0;">Nicht-alkoholische Getr√§nke</h1>
</section>


  <!-- ====================== SCRIPT: ALLES F√úR REZEPTE ====================== -->
<script>
/* ===== Kategorien ===== */
window.CATS = {
  "Fr√ºhst√ºck": [
    "Brot & Aufstriche",
    "Sonstiges"
  ],
  "Hauptspeise": [
    "Suppen & Eint√∂pfe",
    "Pasta & Nudeln",
    "Pizza",
    "Reis & Getreidegerichte",
    "Internationale K√ºche & Currys"
  ],
  "Bakery": [],
  "Snacks & Desserts": [],
  "Drinks": [
    "Alkoholische Getr√§nke",
    "Nicht-alkoholische Getr√§nke"
  ]
};
</script>


<script>
/* ===== Alphabetisch einf√ºgen (TOC + Content) ===== */
(function(){
  const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
  window.normalizeKey = norm;

  const catRoot = (cat)=>{
    const map = {
      'Fr√ºhst√ºck':'#fruehstueck',
      'Hauptspeise':'#hauptspeisen',
      'Bakery':'#bakery',
      'Snacks & Desserts':'#snacks',
      'Drinks':'#drinks'
    };
    return document.querySelector(map[cat]||null);
  };

  // UL im TOC passend zur Kategorie/Unterkategorie finden
  window.getTocList = function(cat, sub){
    const root = catRoot(cat);
    if(!root) return document.querySelector('.cat ul');
    if(!sub)  return root.querySelector('.cat ul');

    // Suche h4 mit passendem Text, nimm das n√§chste UL
    const h4 = Array.from(root.querySelectorAll('h4')).find(el => norm(el.textContent) === norm(sub));
    if(!h4){
      return root.querySelector('.cat ul');
    }
    let el = h4.nextElementSibling;
    while(el && el.tagName !== 'UL') el = el.nextElementSibling;
    return el || root.querySelector('.cat ul');
  };

  // <li> alphabetisch in <ul> einsortieren
  window.insertSortedTOC = function(ul, li){
    const key = norm(li.textContent);
    const items = Array.from(ul.children).filter(x=>x.tagName==='LI');
    const at = items.find(el => norm(el.textContent) > key);
    if (at) ul.insertBefore(li, at); else ul.appendChild(li);
  };

  // Section alphabetisch ins richtige Cover einsortieren
  window.insertSortedSection = function({section, cat, sub}){
    const cover =
      document.querySelector('#' + (sub ? sub.toLowerCase().replace(/[^a-z0-9]+/g,'-') : cat.toLowerCase()) + '-cover')
      || document.querySelector('#' + (cat.toLowerCase()||'') + '-cover')
      || document.body;

    // Kandidaten in derselben Kategorie/Subkategorie
    const all = Array.from(document.querySelectorAll('section.recipe'))
      .filter(s => s !== section
        && ((s.dataset.category||'').toLowerCase() === (cat||'').toLowerCase())
        && ((s.dataset.subcategory||'').toLowerCase() === (sub||'').toLowerCase()));

    const key = norm(section.querySelector('h2')?.textContent);
    const before = all.find(s => norm(s.querySelector('h2')?.textContent) > key);

    if (before) before.parentNode.insertBefore(section, before);
    else cover.insertAdjacentElement('afterend', section);
  };

  // Vorhandene TOCs einmal sortieren
  window.sortExistingTOCLists = function(){
    document.querySelectorAll('.cat ul').forEach(ul=>{
      const items = Array.from(ul.children).filter(li=>li.tagName==='LI');
      items.sort((a,b)=>norm(a.textContent).localeCompare(norm(b.textContent)));
      items.forEach(li=>ul.appendChild(li));
    });
  };
})();
</script>


<script>
/* ===== DB -> Frontend: Alles laden und ins DOM setzen ===== */
(function(){
  async function renderRecipeRecord(rec){
    const id = rec.id;
    const title = rec.title;
    const cat = rec.category;
    const sub = rec.subcategory || '';
    const servings = rec.servings;
    const prep = rec.prep;
    const total = rec.total;
    const ingredients = JSON.parse(rec.ingredients_json || '[]');
    const steps = JSON.parse(rec.steps_json || '[]');

    const buildRecipeSection = window.buildRecipeSection;
    if(!buildRecipeSection){
      console.warn('buildRecipeSection fehlt.');
      return;
    }

    const html = buildRecipeSection({
      id, title, servings, prep, total, ingredients, steps, cat, sub,
      dbId: rec.id
    });

    const t = document.createElement('template');
    t.innerHTML = html.trim();
    const section = t.content.firstElementChild;

    // Alphabetisch einsortieren
    if (typeof insertSortedSection === 'function') {
      insertSortedSection({ section, cat, sub });
    } else {
      document.body.appendChild(section);
    }

    if (window.initRecipeScaling) window.initRecipeScaling();

    // TOC erg√§nzen
    const tocList = window.getTocList(cat, sub);
    if (tocList && !tocList.querySelector(`a[href="#${id}"]`)) {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#' + id;
      a.textContent = title;
      li.appendChild(a);
      insertSortedTOC(tocList, li);
    }
  }

  async function loadAllRecipes(){
    try{
      const res = await fetch('/api/recipes', { headers:{accept:'application/json'} });
      if(!res.ok) throw new Error('GET /api/recipes fehlgeschlagen');
      const list = await res.json();

      for(const rec of list){
        await renderRecipeRecord(rec);
      }

      if (window.sortExistingTOCLists) window.sortExistingTOCLists();
      if (window.initRecipeScaling) window.initRecipeScaling();
    }catch(e){
      console.error('Rezepte laden fehlgeschlagen:', e);
    }
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', loadAllRecipes);
  } else {
    loadAllRecipes();
  }
})();
</script>


<!-- ====================== SCRIPT: PORTIONEN + EDIT/DELETE ====================== -->
<script>
/* ========= 1) Portionsrechner ========= */
(function(){
  function num(v){ if(v==null) return null; const n=parseFloat(String(v).replace(',','.')); return isNaN(n)?null:n; }
  function fmt(x){ return (x>=1 || Math.abs(x-Math.round(x))<1e-9) ? String(Math.round(x)) : String(Math.round(x*10)/10); }

  function bindSection(sec){
    const input = sec.querySelector('.meta input[type="number"]');
    if(!input) return;

    const baseServings = parseFloat(input.getAttribute('value') || input.value || '1') || 1;
    sec.dataset.baseServings = String(baseServings);

    sec.querySelectorAll('[data-base]').forEach(s=>{
      if(!s.dataset.orig){
        const o = num(s.getAttribute('data-base'));
        if(o!=null) s.dataset.orig = String(o);
      }
    });

    const update = ()=>{
      const desired = Math.max(1, parseFloat(input.value || '1') || 1);
      const f = desired / (parseFloat(sec.dataset.baseServings||'1') || 1);
      sec.querySelectorAll('[data-base]').forEach(s=>{
        const o = num(s.dataset.orig); if(o==null) return;
        s.textContent = fmt(o * f);
      });
    };

    input.addEventListener('input', update);
    input.addEventListener('change', update);
    update();
  }

  window.initRecipeScaling = function(){
    document.querySelectorAll('section.recipe').forEach(bindSection);
  };

  window.updateRecipe = function(){
    const sec = event?.target ? event.target.closest('section.recipe') : null;
    if(sec) bindSection(sec);
  };

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>window.initRecipeScaling());
  } else {
    window.initRecipeScaling();
  }
})();
</script>


<script>
/* ========= 2) Modal: Editieren/L√∂schen + Submit ========= */
(function(){
  const modal = document.getElementById('addRecipeModal');
  const form  = document.getElementById('recipeForm');
  const catSelect = document.getElementById('category');
  const subSelect = document.getElementById('subcategory');

  window.__editingRecipeId = null;

  function openModal(){ modal.style.display = 'flex'; }
  function closeModal(){ modal.style.display = 'none'; window.__editingRecipeId = null; }

  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;

    // --- l√∂schen ---
    if (btn.classList.contains('btn-delete')) {
      const dbId = btn.dataset.id;
      if (!dbId) return;
      if (!confirm('Dieses Rezept wirklich l√∂schen?')) return;

      const res = await fetch('/api/recipes?id=' + encodeURIComponent(dbId), { method: 'DELETE' });
      if(!res.ok){ alert('L√∂schen fehlgeschlagen'); return; }

      const sec = btn.closest('section.recipe');
      if (sec) {
        const hash = '#' + sec.id;
        sec.remove();
        document.querySelectorAll(`.cat ul li a[href="${hash}"]`).forEach(a => a.parentElement.remove());
      }
      return;
    }

    // --- bearbeiten ---
    if (btn.classList.contains('btn-edit')) {
      const sec = btn.closest('section.recipe');
      const dbId = btn.dataset.id;
      if (!sec || !dbId) return;

      window.__editingRecipeId = dbId;

      const title = sec.querySelector('h2')?.textContent.trim() || '';
      const servings = parseInt(sec.querySelector('.meta input[type=number]')?.value || '1', 10) || 1;
      const cat = sec.dataset.category || '';
      const sub = sec.dataset.subcategory || '';

      const ings = Array.from(sec.querySelectorAll('.zutaten li')).map(li=>{
        const span = li.querySelector('[data-base]');
        if (span) {
          const base = span.getAttribute('data-base') || span.dataset.orig || span.textContent.trim();
          const rest = li.textContent.replace(span.textContent,'').trim();
          return `${base} ${rest}`;
        }
        return li.textContent.trim();
      });

      const steps = Array.from(sec.querySelectorAll('.zubereitung ol li')).map(li=>li.textContent.trim());

      document.getElementById('title').value = title;
      document.getElementById('servings').value = String(servings);
      document.getElementById('prep').value =
        (sec.querySelector('.meta')?.textContent.match(/Zubereitungszeit:\s*([^|]+)/)?.[1] || '').trim();
      document.getElementById('total').value =
        (sec.querySelector('.meta')?.textContent.match(/Gesamtzeit:\s*([^|]+)/)?.[1] || '').trim();
      document.getElementById('ingredients').value = ings.join('\n');
      document.getElementById('steps').value = steps.join('\n');

      if (cat) {
        catSelect.value = cat;
        catSelect.dispatchEvent(new Event('change'));
        if (sub) subSelect.value = sub;
      }

      openModal();
      return;
    }
  });

  // --- submit: PUT oder POST ---
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    const title = document.getElementById('title').value.trim();
    const category = catSelect.value;
    const subcategory = (subSelect.value || '').trim();
    const servings = Math.max(1, parseInt(document.getElementById('servings').value || '1', 10));
    const prep = document.getElementById('prep').value.trim();
    const total = document.getElementById('total').value.trim();
    const ingredients = (document.getElementById('ingredients').value || '').split('\n').map(s=>s.trim()).filter(Boolean);
    const steps = (document.getElementById('steps').value || '').split('\n').map(s=>s.trim()).filter(Boolean);

    if (!title || !category || !prep || !total || !ingredients.length || !steps.length) {
      alert('Bitte alle Pflichtfelder ausf√ºllen.'); return;
    }

    // ===== bearbeiten =====
    if (window.__editingRecipeId) {
      const res = await fetch('/api/recipes?id=' + encodeURIComponent(window.__editingRecipeId), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, category, subcategory, servings, prep, total, ingredients, steps })
      });
      if (!res.ok) { alert('Speichern fehlgeschlagen'); return; }
      location.reload();
      return;
    }

    // ===== neu anlegen =====
    const res = await fetch('/api/recipes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, category, subcategory, servings, prep, total, ingredients, steps })
    });
    if (!res.ok) { alert('Speichern fehlgeschlagen'); return; }
    const data = await res.json();

    // DOM-ID erzeugen
    const slug = (s) => s.toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')
      .slice(0,64) || 'rezept';
    let domId = slug(title);
    let i=2; while(document.getElementById(domId)) domId = slug(title) + '-' + (i++);

    const html = buildRecipeSection({
      id: domId,
      title, servings, prep, total,
      ingredients, steps,
      cat: category, sub: subcategory,
      dbId: data.id
    });
    const t = document.createElement('template');
    t.innerHTML = html.trim();
    const section = t.content.firstElementChild;

    insertSortedSection({ section, cat: category, sub: subcategory });

    if (typeof window.initRecipeScaling === 'function') window.initRecipeScaling();

    const tocList = getTocList(category, subcategory);
    if (tocList) {
      const li = document.createElement('li');
      const a = document.createElement('a'); a.href = '#' + domId; a.textContent = title;
      li.appendChild(a);
      insertSortedTOC(tocList, li);
    }

    if (typeof rebuildSearch === 'function') rebuildSearch();

    closeModal();
    setTimeout(()=>{ location.hash = '#' + domId; }, 50);
  });
})();
</script>


  <!-- ====================== SCRIPT: TEMPLATE F√úR REZEPTE ====================== -->
<script>
window.buildRecipeSection = function({id, title, servings, prep, total, ingredients, steps, cat, sub, dbId}){
  // Zutaten als <li> + Portionen-Werte
  const ingLis = ingredients.map(line=>{
    const m = String(line).trim().match(/^(\d+(?:[.,]\d+)?)\s+(.*)$/);
    if(m){
      const val = m[1].replace(',','.');
      const rest = m[2];
      return `<li><span data-base="${val}">${val}</span> ${rest}</li>`;
    }
    return `<li>${String(line).trim()}</li>`;
  }).join('\n');

  // Zubereitungsschritte
  const stepsOl = steps.map(s=>`<li>${String(s).trim()}</li>`).join('\n');

  // Farb-Styles je Hauptkategorie
  const catStyle =
    cat === "Fr√ºhst√ºck" ? "background:#fffbea; border:1px solid #ffe58f;" :
    cat === "Hauptspeise" ? "background:#f0fff4; border:1px solid #b7eb8f;" :
    cat === "Bakery" ? "background:#fff0f3; border:1px solid #f7c6d5;" :
    cat === "Snacks & Desserts" ? "background:#fff7f0; border:1px solid #ffd1a3;" :
    cat === "Drinks" ? "background:#f0f8ff; border:1px solid #b3d9ff;" :
    "background:#f9f9f9; border:1px solid #ddd;";

  // Kategorie-Classes (f√ºr CSS)
  const catClass =
    cat === "Fr√ºhst√ºck" ? "fruehstueck" :
    cat === "Hauptspeise" ? "hauptspeisen" :
    cat === "Bakery" ? "bakery" :
    cat === "Snacks & Desserts" ? "snacks" :
    cat === "Drinks" ? "drinks" : "";

  return `
<section id="${id}" class="recipe ${catClass}"
         style="${catStyle} padding:20px; border-radius:16px; margin:18px 12px;"
         data-recipe-id="${dbId || id}"
         data-category="${cat || ''}"
         data-subcategory="${sub || ''}">
  <div style="display:flex; gap:8px; justify-content:flex-end; margin-bottom:6px;">
    <button class="btn btn-edit" data-id="${dbId || id}" style="padding:6px 10px;">‚úèÔ∏è Bearbeiten</button>
    <button class="btn btn-delete" data-id="${dbId || id}" style="padding:6px 10px;">üóëÔ∏è L√∂schen</button>
  </div>

  <h2>${title}</h2>
  <p class="meta">
    ‚è±Ô∏è Zubereitungszeit: ${prep} | üïí Gesamtzeit: ${total} | üë• Portionen:
    <input type="number" value="${servings}" min="1" style="width:64px"
           onchange="window.updateRecipe && window.updateRecipe()">
  </p>

  <div class="zutaten">
    <h3>ü•ï Zutaten</h3>
    <ul id="${id}-zutaten">
      ${ingLis}
    </ul>
  </div>

  <div class="zubereitung">
    <h3>üë©‚Äçüç≥ Zubereitung</h3>
    <ol>
      ${stepsOl}
    </ol>
  </div>
</section>`;
};
</script>



  <!-- ====================== SCRIPT: ZIELORTE + SORTIERUNG ====================== -->
<script>
/* ===== Ziel-Orte (Cover + TOC-Liste) bestimmen ===== */
window.resolveTargets = function(cat, subcat){
  const pick = sel =>
    sel.split(',').map(s=>s.trim()).map(s=>document.querySelector(s)).find(Boolean);

  const map = {
    "Fr√ºhst√ºck": {
      "Brot":        { cover:"#fruehstueck-brot-cover", toc:"#fruehstueck ul" },
      "Aufstriche":  { cover:"#fruehstueck-aufstriche-cover", toc:"#fruehstueck ul" },
      "Sonstiges":   { cover:"#fruehstueck-sonstiges-cover", toc:"#fruehstueck ul" }
    },
    "Hauptspeise": {
      "Suppen & Eint√∂pfe":             { cover:"#suppen-und-eintoepfe-cover", toc:"#hauptspeisen ul" },
      "Pasta & Nudeln":                { cover:"#pasta-und-nudeln-cover", toc:"#hauptspeisen ul" },
      "Pizza":                         { cover:"#pizza-cover", toc:"#hauptspeisen ul" },
      "Reis & Getreidegerichte":       { cover:"#reis-und-getreide-cover", toc:"#hauptspeisen ul" },
      "Internationale K√ºche & Currys": { cover:"#internationale-kueche-und-currys-cover", toc:"#hauptspeisen ul" },
      "Snacks, Beilage & Fingerfood":  { cover:"#snacks-beilagen-und-fingerfood-cover", toc:"#hauptspeisen ul" },
      "Basics & Saucen":               { cover:"#basics-und-saucen-cover", toc:"#hauptspeisen ul" },
      "Curry-Paste":                   { cover:"#curry-pasten-cover", toc:"#hauptspeisen ul" }
    },
    "Bakery": {
      "Kuchen & Torten":      { cover:"#kuchen-und-torten-cover", toc:"#bakery ul" },
      "Pl√§tzchen & Kleingeb√§ck": { cover:"#plaetzchen-und-kleingebaeck-cover", toc:"#bakery ul" },
      "Sonstiges Geb√§ck":     { cover:"#sonstiges-gebaeck-cover", toc:"#bakery ul" }
    },
    "Snacks & Desserts": { cover:"#snacks-cover", toc:"#snacks ul" },
    "Drinks": {
      "Alkoholische Getr√§nke":     { cover:"#drinks-alkoholisch-cover", toc:"#drinks ul" },
      "Nicht-alkoholische Getr√§nke": { cover:"#drinks-alkoholfrei-cover", toc:"#drinks ul" }
    }
  };

  let cfg = map[cat];
  if (cfg && typeof cfg === 'object' && subcat && cfg[subcat]) cfg = cfg[subcat];

  const contentAnchor =
    (cfg && pick(cfg.cover)) ||
    document.querySelector('#' + (
      cat === 'Fr√ºhst√ºck' ? 'fruehstueck' :
      cat && cat.toLowerCase().includes('haupt') ? 'hauptspeisen' :
      cat && cat.toLowerCase().includes('snacks') ? 'snacks' :
      (cat || '').toLowerCase()
    ) + '-cover') ||
    document.body;

  const tocList = (cfg && cfg.toc ? document.querySelector(cfg.toc) : null)
    || document.querySelector('#' + (
        cat === 'Fr√ºhst√ºck' ? 'fruehstueck' :
        cat && cat.toLowerCase().includes('haupt') ? 'hauptspeisen' :
        cat && cat.toLowerCase().includes('snacks') ? 'snacks' :
        (cat || '').toLowerCase()
      ) + ' ul')
    || document.querySelector('.cat ul');

  return { tocList, contentAnchor };
};

/* ===== Alphabetische Sortierung ===== */
(function(){
  const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
  window.normalizeKey = norm;

  // Alphabetisch ins Inhaltsverzeichnis einsortieren
  window.insertSortedTOC = function(ul, li){
    const key = norm(li.textContent);
    const items = Array.from(ul.children).filter(x=>x.tagName==='LI');
    const at = items.find(el => norm(el.textContent) > key);
    if (at) ul.insertBefore(li, at); else ul.appendChild(li);
  };

  // Alphabetisch in den Content einsortieren (unter passendem Cover)
  window.insertSortedSection = function({section, cat, sub}){
    const t = (typeof resolveTargets === 'function') ? resolveTargets(cat, sub) : null;
    const cover =
      t?.contentAnchor ||
      document.querySelector('#' + (cat?.toLowerCase()||'') + '-cover') ||
      document.body;

    const all = Array.from(document.querySelectorAll('section.recipe'))
      .filter(s => s !== section
        && ((s.dataset.category||'').toLowerCase() === (cat||'').toLowerCase())
        && ((s.dataset.subcategory||'') === (sub||'')));

    const key = norm(section.querySelector('h2')?.textContent);
    const before = all.find(s => norm(s.querySelector('h2')?.textContent) > key);

    if (before) before.parentNode.insertBefore(section, before);
    else cover.insertAdjacentElement('afterend', section);
  };

  // Bestehende TOC-Listen einmalig sortieren
  window.sortExistingTOCLists = function(){
    document.querySelectorAll('.cat ul').forEach(ul=>{
      const items = Array.from(ul.children).filter(li=>li.tagName==='LI');
      items.sort((a,b)=>norm(a.textContent).localeCompare(norm(b.textContent)));
      items.forEach(li=>ul.appendChild(li));
    });
  };
})();
</script>


  <!-- ====================== SCRIPT: DB -> FRONTEND RENDER ====================== -->
<script>
(function(){
  async function renderRecipeRecord(rec){
    const id        = rec.id;
    const title     = rec.title;
    const cat       = rec.category;
    const sub       = rec.subcategory || '';
    const servings  = rec.servings;
    const prep      = rec.prep;
    const total     = rec.total;
    const ingredients = JSON.parse(rec.ingredients_json || '[]');
    const steps       = JSON.parse(rec.steps_json || '[]');

    const resolveTargets   = window.resolveTargets;
    const buildRecipeSection = window.buildRecipeSection;

    if(!resolveTargets || !buildRecipeSection){
      console.warn('resolveTargets/buildRecipeSection nicht global verf√ºgbar.');
      return;
    }

    // Ziel (Cover & TOC) ermitteln
    const { tocList } = resolveTargets(cat, sub);

    // HTML bauen
    const html = buildRecipeSection({
      id, title, servings, prep, total, ingredients, steps, cat, sub,
      dbId: rec.id
    });

    const t = document.createElement('template');
    t.innerHTML = html.trim();
    const section = t.content.firstElementChild;

    // Alphabetisch einsortieren
    if (typeof insertSortedSection === 'function') {
      insertSortedSection({ section, cat, sub });
    } else {
      document.body.appendChild(section);
    }

    // Portionsrechner aktivieren
    if (window.initRecipeScaling) window.initRecipeScaling();

    // Inhaltsverzeichnis-Eintrag erg√§nzen
    if (tocList && !tocList.querySelector(`a[href="#${id}"]`)) {
      const li = document.createElement('li');
      const a  = document.createElement('a');
      a.href = '#' + id;
      a.textContent = title;
      li.appendChild(a);

      if (typeof insertSortedTOC === 'function') {
        insertSortedTOC(tocList, li);
      } else {
        tocList.appendChild(li);
      }
    }
  }

  async function loadAllRecipes(){
    try{
      const res = await fetch('/api/recipes', { headers:{accept:'application/json'} });
      if(!res.ok) throw new Error('GET /api/recipes fehlgeschlagen');
      const list = await res.json();

      for(const rec of list){
        await renderRecipeRecord(rec);
      }

      // Nachtr√§gliche Initialisierung
      if (window.rebuildSearch) window.rebuildSearch();
      if (window.initRecipeScaling) window.initRecipeScaling();
      if (window.sortExistingTOCLists) window.sortExistingTOCLists();
    }catch(e){
      console.error('Rezepte laden fehlgeschlagen:', e);
    }
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', loadAllRecipes);
  } else {
    loadAllRecipes();
  }
})();
</script>

<!-- ====================== SCRIPT: PORTIONSRECHNER ====================== -->
<script>
(function(){
  function num(v){ 
    if(v==null) return null; 
    const n=parseFloat(String(v).replace(',','.')); 
    return isNaN(n)?null:n; 
  }
  function fmt(x){ 
    return (x>=1 || Math.abs(x-Math.round(x))<1e-9) 
      ? String(Math.round(x)) 
      : String(Math.round(x*10)/10); 
  }

  function bindSection(sec){
    const input = sec.querySelector('.meta input[type="number"]');
    if(!input) return;

    const baseServings = parseFloat(input.getAttribute('value') || input.value || '1') || 1;
    sec.dataset.baseServings = String(baseServings);

    // Ursprungswerte speichern
    sec.querySelectorAll('[data-base]').forEach(s=>{
      if(!s.dataset.orig){
        const o = num(s.getAttribute('data-base'));
        if(o!=null) s.dataset.orig = String(o);
      }
    });

    const update = ()=>{
      const desired = Math.max(1, parseFloat(input.value || '1') || 1);
      const f = desired / (parseFloat(sec.dataset.baseServings||'1') || 1);
      sec.querySelectorAll('[data-base]').forEach(s=>{
        const o = num(s.dataset.orig); 
        if(o==null) return;
        s.textContent = fmt(o * f);
      });
    };

    input.addEventListener('input', update);
    input.addEventListener('change', update);
    update();
  }

  // Global nutzbar
  window.initRecipeScaling = function(){
    document.querySelectorAll('section.recipe').forEach(bindSection);
  };

  window.updateRecipe = function(){
    const sec = event?.target ? event.target.closest('section.recipe') : null;
    if(sec) bindSection(sec);
  };

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>window.initRecipeScaling());
  } else {
    window.initRecipeScaling();
  }
})();
</script>

  <!-- ====================== SCRIPT: TOC-HELFER ====================== -->
<script>
(function(){
  window.addToTOC = function({title, id, cat, sub}){
    let ul = null;

    // Versuche zuerst das Ziel mit resolveTargets zu finden
    if (typeof resolveTargets === 'function') {
      try {
        const t = resolveTargets(cat, sub);
        ul = t?.tocList || null;
      } catch {}
    }

    // Fallback: Kategorie-Logik (wenn resolveTargets nichts liefert)
    if(!ul){
      const catId =
        cat === 'Bakery' ? '#bakery' :
        cat === 'Drinks' ? '#drinks' :
        (cat && cat.toLowerCase().includes('haupt')) ? '#hauptspeisen' :
        (cat && cat.toLowerCase().includes('snacks')) ? '#snacks' :
        (cat && (cat.toLowerCase().includes('fr√ºh') || cat.toLowerCase().includes('frueh'))) ? '#fruehstueck' :
        null;

      const root = catId ? document.querySelector(catId) : document;
      ul = root?.querySelector('.cat ul') || root?.querySelector('ul') || document.querySelector('.cat ul');
    }

    if(!ul) return;

    // Neuen Listeneintrag erstellen
    const li = document.createElement('li');
    const a  = document.createElement('a');
    a.href = '#' + id;
    a.textContent = title;
    li.appendChild(a);

    // Alphabetisch einsortieren
    if (typeof insertSortedTOC === 'function') {
      insertSortedTOC(ul, li);
    } else {
      ul.appendChild(li);
    }
  };
})();
</script>


  <!-- ====================== SCRIPT: MODAL ADD/EDIT/DELETE ====================== -->
<script>
(function(){
  const modal = document.getElementById('addRecipeModal');
  const form  = document.getElementById('recipeForm');
  const catSelect = document.getElementById('category');
  const subSelect = document.getElementById('subcategory');

  // Wird gesetzt, wenn ein bestehendes Rezept bearbeitet wird
  window.__editingRecipeId = null;

  function openModal(){ modal.style.display = 'flex'; }
  function closeModal(){ modal.style.display = 'none'; window.__editingRecipeId = null; }

  // Klick-Handler f√ºr Bearbeiten & L√∂schen
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;

    // --------- L√ñSCHEN ---------
    if (btn.classList.contains('btn-delete')) {
      const dbId = btn.dataset.id;
      if (!dbId) return;
      if (!confirm('Dieses Rezept wirklich l√∂schen?')) return;

      const res = await fetch('/api/recipes?id=' + encodeURIComponent(dbId), { method: 'DELETE' });
      if(!res.ok){ alert('L√∂schen fehlgeschlagen'); return; }

      const sec = btn.closest('section.recipe');
      if (sec) {
        const hash = '#' + sec.id;
        sec.remove();
        // Aus Inhaltsverzeichnis l√∂schen
        document.querySelectorAll(`.cat ul li a[href="${hash}"]`).forEach(a => a.parentElement.remove());
      }
      return;
    }

    // --------- BEARBEITEN ---------
    if (btn.classList.contains('btn-edit')) {
      const sec = btn.closest('section.recipe');
      const dbId = btn.dataset.id;
      if (!sec || !dbId) return;

      window.__editingRecipeId = dbId;

      // Formulardaten ausf√ºllen
      const title = sec.querySelector('h2')?.textContent.trim() || '';
      const servings = parseInt(sec.querySelector('.meta input[type=number]')?.value || '1', 10) || 1;
      const cat = sec.dataset.category || '';
      const sub = sec.dataset.subcategory || '';

      const ings = Array.from(sec.querySelectorAll('.zutaten li')).map(li=>{
        const span = li.querySelector('[data-base]');
        if (span) {
          const base = span.getAttribute('data-base') || span.dataset.orig || span.textContent.trim();
          const rest = li.textContent.replace(span.textContent,'').trim();
          return `${base} ${rest}`;
        }
        return li.textContent.trim();
      });

      const steps = Array.from(sec.querySelectorAll('.zubereitung ol li')).map(li=>li.textContent.trim());

      document.getElementById('title').value = title;
      document.getElementById('servings').value = String(servings);
      document.getElementById('prep').value =
        (sec.querySelector('.meta')?.textContent.match(/Zubereitungszeit:\s*([^|]+)/)?.[1] || '').trim();
      document.getElementById('total').value =
        (sec.querySelector('.meta')?.textContent.match(/Gesamtzeit:\s*([^|]+)/)?.[1] || '').trim();
      document.getElementById('ingredients').value = ings.join('\n');
      document.getElementById('steps').value = steps.join('\n');

      if (cat) {
        catSelect.value = cat;
        catSelect.dispatchEvent(new Event('change'));
        if (sub) subSelect.value = sub;
      }

      openModal();
      return;
    }
  });

  // --------- SPEICHERN (Submit) ---------
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    const title = document.getElementById('title').value.trim();
    const category = catSelect.value;
    const subcategory = (subSelect.value || '').trim();
    const servings = Math.max(1, parseInt(document.getElementById('servings').value || '1', 10));
    const prep = document.getElementById('prep').value.trim();
    const total = document.getElementById('total').value.trim();
    const ingredients = (document.getElementById('ingredients').value || '').split('\n').map(s=>s.trim()).filter(Boolean);
    const steps = (document.getElementById('steps').value || '').split('\n').map(s=>s.trim()).filter(Boolean);

    if (!title || !category || !prep || !total || !ingredients.length || !steps.length) {
      alert('Bitte alle Pflichtfelder ausf√ºllen.'); return;
    }

    // --------- UPDATE bestehendes Rezept ---------
    if (window.__editingRecipeId) {
      const res = await fetch('/api/recipes?id=' + encodeURIComponent(window.__editingRecipeId), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, category, subcategory, servings, prep, total, ingredients, steps })
      });
      if (!res.ok) { alert('Speichern fehlgeschlagen'); return; }
      location.reload();
      return;
    }

    // --------- NEUES Rezept ---------
    const res = await fetch('/api/recipes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, category, subcategory, servings, prep, total, ingredients, steps })
    });
    if (!res.ok) { alert('Speichern fehlgeschlagen'); return; }
    const data = await res.json();

    // Slug aus Titel generieren
    const slug = (s) => s.toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')
      .slice(0,64) || 'rezept';
    let domId = slug(title);
    let i=2; while(document.getElementById(domId)) domId = slug(title) + '-' + (i++);

    const targets = (typeof resolveTargets === 'function') ? resolveTargets(category, subcategory) : {};
    const contentAnchor = targets?.contentAnchor || document.body;
    const tocList = targets?.tocList || document.querySelector('.cat ul');

    const html = buildRecipeSection({
      id: domId,
      title, servings, prep, total,
      ingredients, steps,
      cat: category, sub: subcategory,
      dbId: data.id
    });
    const t = document.createElement('template');
    t.innerHTML = html.trim();
    const section = t.content.firstElementChild;

    if (typeof insertSortedSection === 'function') {
      insertSortedSection({ section, cat: category, sub: subcategory });
    } else {
      contentAnchor.insertAdjacentElement('afterend', section);
    }

    if (typeof window.initRecipeScaling === 'function') window.initRecipeScaling();

    if (tocList) {
      const li = document.createElement('li');
      const a = document.createElement('a'); a.href = '#' + domId; a.textContent = title;
      li.appendChild(a);

      if (typeof insertSortedTOC === 'function') {
        insertSortedTOC(tocList, li);
      } else {
        tocList.appendChild(li);
      }
    }

    if (typeof rebuildSearch === 'function') rebuildSearch();

    closeModal();
    setTimeout(()=>{ location.hash = '#' + domId; }, 50);
  });
})();
</script>


  <!-- ====================== GLOBAL SERVINGS FIX + STYLE ====================== -->
<style>
  /* Alle "Zur√ºck"-Buttons komplett ausblenden */
  .back-button { display: none !important; }

  /* Einheitliche Rezeptkarten */
  section.recipe {
    padding:20px;
    border-radius:16px;
    margin:18px 12px;
    border:1px solid rgba(0,0,0,0.08);
    background:#fff;
  }

  /* Kategorie-Farben √ºbernehmen */
  section.recipe.fruehstueck { background:#fffce8; border-color:#f5e88f; }
  section.recipe.hauptspeise { background:#fff8f3; border-color:#ffccb3; }
  section.recipe.bakery { background:#fff0f3; border-color:#f7c6d5; }
  section.recipe.snacks { background:#fff7f0; border-color:#ffd1a3; }
  section.recipe.drinks { background:#f0f8ff; border-color:#b3d9ff; }

  /* iPhone/kleine Screens */
  @media (max-width: 430px) {
    .recipe { margin: 16px 10px; border-radius: 18px; }
    .recipe h2 { font-size: 1.15rem; }
    .meta input[type="number"] { width: 64px !important; }
  }
</style>
  
  
  
